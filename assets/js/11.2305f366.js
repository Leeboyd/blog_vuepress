(window.webpackJsonp=window.webpackJsonp||[]).push([[11],{65:function(t,e,s){"use strict";s.r(e);var i=s(0),n=Object(i.a)({},function(){var t=this,e=t.$createElement,s=t._self._c||e;return s("div",{staticClass:"content"},[t._m(0),t._v(" "),t._m(1),t._v(" "),t._m(2),t._v(" "),s("p",[t._v("Ｎginx 除了用於 web server，也可用於做到 reverse proxy, load balancer, and HTTP cache.")]),t._v(" "),s("p",[t._v("適當地調整 nginx configuration，可提升效能以及減少主機負擔。")]),t._v(" "),s("p",[t._v("本文將針對以下項目進行調整與説明：")]),t._v(" "),t._m(3),t._v(" "),t._m(4),t._v(" "),t._m(5),t._v(" "),t._m(6),t._v(" "),t._m(7),t._v(" "),t._m(8),t._m(9),t._v(" "),t._m(10),t._v(" "),t._m(11),t._v(" "),t._m(12),t._v(" "),t._m(13),t._v(" "),t._m(14),t._v(" "),t._m(15),t._v(" "),t._m(16),t._v(" "),t._m(17),t._v(" "),s("p",[t._v("其他設定細節，我就沒有研究了。")]),t._v(" "),t._m(18),t._v(" "),t._m(19),t._v(" "),t._m(20),t._v(" "),t._m(21),t._v(" "),t._m(22),t._v(" "),s("p",[t._v("設定壓縮比的等級，壓縮比小處理速度快，壓縮比大處理慢，Rule of thumb 是設定 3 即可。")]),t._v(" "),t._m(23),t._v(" "),t._m(24),t._v(" "),t._m(25),t._v(" "),t._m(26),t._v(" "),t._m(27),t._v(" "),t._m(28),t._v(" "),t._m(29),t._m(30),t._v(" "),t._m(31),t._v(" "),t._m(32),t._v(" "),t._m(33),t._v(" "),t._m(34),t._v(" "),s("p",[t._v("Cache-Control 除了使用 nginx expires 提供 max-age 資訊外，也可以額外使用 add_header 進行覆寫預設行為：")]),t._v(" "),t._m(35),t._v(" "),t._m(36),t._v(" "),s("p",[t._v("判斷這個 response 可不可以快取，因為 max-age 已經告訴你這個 response 要快取多久，所以這個設定可有可無。")]),t._v(" "),t._m(37),t._v(" "),s("p",[t._v("只允許瀏覽器可以快取，但是 CDN 不能快取。")]),t._v(" "),t._m(38),t._v(" "),s("p",[t._v("並不是不快取，瀏覽器會先與 server 確認這個資源是否有變更（如 ETag 驗證），如果資源沒有任何變更，則瀏覽器會避免下載。")]),t._v(" "),t._m(39),t._v(" "),s("p",[t._v("則是直接禁止瀏覽器快取儲存任何 response，例如含有個人隱私資料或銀行資料。")]),t._v(" "),t._m(40),t._v(" "),s("p",[t._v("產生 token 給用戶端，供給判斷資源是否已變更，不需要額外設定，預設已開啟")]),t._v(" "),t._m(41),t._v(" "),s("p",[t._v("再次參考圖片")]),t._v(" "),t._m(42),t._v(" "),s("p",[t._v("在第一次請求過 120 秒後，用戶端又想對 server 發新的請求時，用戶端會先去看之前的回應是否過期，發現已超過 120 秒，於是又再一次發請求，重新下載一次檔案。")]),t._v(" "),s("p",[t._v("如果這個檔案還是一樣，為什麼用戶端不直接用原本快取的檔案就好？")]),t._v(" "),s("p",[t._v("這就是 ETag 要解決的問題：nginx 會產生並回傳一個 token 給用戶端，通常是檔案的 hash。用戶端只需要在下一個請求時將其夾帶給 server，如果 ETag 仍然一致，說明資源未被修改，就不須重新下載。")]),t._v(" "),t._m(43),t._v(" "),s("p",[t._v("在開發時，當開發者提交了 CSS 的更新到 server 上，我希望我能夠及時看到變化，但我 nginx 設定 expires 1d，在瀏覽器快取的版本過期以前都會一直使用舊版 CSS。")]),t._v(" "),t._m(44),t._v(" "),t._m(45),t._v(" "),t._m(46),t._v(" "),t._m(47),t._v(" "),s("p",[t._v("實際上，只能透過變更資源網址，強制使用者下載新的。例如在檔案名稱中嵌入 hash，例如 style.x234dff.css 即可，搭配 webpack 可以自動在打包時做到此需求。")]),t._v(" "),t._m(48),t._v(" "),s("p",[t._v("除了 client 端的 cache，nginx 做為反向代理，也可以利用 cache 減少打到後端/上游 server 的請求數量。")]),t._v(" "),t._m(49),t._v(" "),t._m(50),t._m(51),t._v(" "),t._m(52),t._v(" "),t._m(53),t._v(" "),t._m(54),t._v(" "),s("ul",[t._m(55),t._v(" "),s("li",[s("p",[t._v("use_temp_path: 如果設 off，則 nginx 會將暫存檔直接寫入指定的 cache 路徑中，而不是存到額外指定的 "),s("a",{attrs:{href:"http://nginx.org/en/docs/http/ngx_http_proxy_module.html#proxy_temp_path",target:"_blank",rel:"noopener noreferrer"}},[t._v("proxy_temp_path"),s("OutboundLink")],1),t._v(" ，官方建議 off，避免檔案在系統中有多份拷貝。")])])]),t._v(" "),t._m(56),t._v(" "),t._m(57),t._v(" "),t._m(58),t._v(" "),s("p",[t._v("當設定完成後，別忘了先檢驗有沒有錯誤，使用")]),t._v(" "),t._m(59),t._v(" "),s("p",[t._v("nginx 會很貼心的提醒你哪邊有錯誤。")]),t._v(" "),t._m(60),t._v(" "),t._m(61),t._v(" "),t._m(62),t._v(" "),s("hr",{staticClass:"footnotes-sep"}),t._v(" "),s("section",{staticClass:"footnotes"},[s("ol",{staticClass:"footnotes-list"},[s("li",{staticClass:"footnote-item",attrs:{id:"fn1"}},[s("p",[s("a",{attrs:{href:"http://nginx.org/en/docs/http/ngx_http_gzip_module.html",target:"_blank",rel:"noopener noreferrer"}},[t._v("Module ngx_http_gzip_module"),s("OutboundLink")],1),t._v(" "),s("a",{staticClass:"footnote-backref",attrs:{href:"#fnref1"}},[t._v("↩︎")])])]),t._v(" "),s("li",{staticClass:"footnote-item",attrs:{id:"fn2"}},[s("p",[s("a",{attrs:{href:"https://developers.google.com/web/fundamentals/performance/optimizing-content-efficiency/http-caching?hl=zh-tw",target:"_blank",rel:"noopener noreferrer"}},[t._v("HTTP 快取"),s("OutboundLink")],1),t._v(" "),s("a",{staticClass:"footnote-backref",attrs:{href:"#fnref2"}},[t._v("↩︎")])])]),t._v(" "),s("li",{staticClass:"footnote-item",attrs:{id:"fn3"}},[s("p",[s("a",{attrs:{href:"http://nginx.org/en/docs/http/ngx_http_headers_module.html",target:"_blank",rel:"noopener noreferrer"}},[t._v("Module ngx_http_headers_module"),s("OutboundLink")],1),t._v(" "),s("a",{staticClass:"footnote-backref",attrs:{href:"#fnref3"}},[t._v("↩︎")])])]),t._v(" "),s("li",{staticClass:"footnote-item",attrs:{id:"fn4"}},[s("p",[s("a",{attrs:{href:"http://nginx.org/en/docs/http/ngx_http_proxy_module.html",target:"_blank",rel:"noopener noreferrer"}},[t._v("Module ngx_http_proxy_module"),s("OutboundLink")],1),t._v(" "),s("a",{staticClass:"footnote-backref",attrs:{href:"#fnref4"}},[t._v("↩︎")])])]),t._v(" "),s("li",{staticClass:"footnote-item",attrs:{id:"fn5"}},[s("p",[s("a",{attrs:{href:"https://www.jianshu.com/p/625c2b15dad5",target:"_blank",rel:"noopener noreferrer"}},[t._v("Nginx Proxy Cache原理和最佳实践"),s("OutboundLink")],1),t._v(" "),s("a",{staticClass:"footnote-backref",attrs:{href:"#fnref5"}},[t._v("↩︎")])])])])])])},[function(){var t=this.$createElement,e=this._self._c||t;return e("h1",{attrs:{id:"nginx-tuning-效能提升"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#nginx-tuning-效能提升","aria-hidden":"true"}},[this._v("#")]),this._v(" NGINX Tuning - 效能提升")])},function(){var t=this.$createElement,e=this._self._c||t;return e("h5",{attrs:{id:"tags-nginx-cache"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#tags-nginx-cache","aria-hidden":"true"}},[this._v("#")]),this._v(" tags: "),e("code",[this._v("nginx")]),this._v(", "),e("code",[this._v("cache")])])},function(){var t=this.$createElement,e=this._self._c||t;return e("h2",{attrs:{id:"摘要"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#摘要","aria-hidden":"true"}},[this._v("#")]),this._v(" 摘要")])},function(){var t=this.$createElement,e=this._self._c||t;return e("ul",[e("li",[this._v("Gzip")]),this._v(" "),e("li",[this._v("client 端 cache")]),this._v(" "),e("li",[this._v("server 端 cache")])])},function(){var t=this.$createElement,e=this._self._c||t;return e("h2",{attrs:{id:"gzip"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#gzip","aria-hidden":"true"}},[this._v("#")]),this._v(" Gzip")])},function(){var t=this.$createElement,e=this._self._c||t;return e("p",[this._v("使用 Gzip 壓縮 可以節省流量，加速用戶端的回應速度，提升使用者體驗，但是 trade-off 就是會增加額外的 CPU 運算量。"),e("sup",{staticClass:"footnote-ref"},[e("a",{attrs:{href:"#fn1",id:"fnref1"}},[this._v("[1]")])])])},function(){var t=this.$createElement,e=this._self._c||t;return e("h3",{attrs:{id:"設定範例"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#設定範例","aria-hidden":"true"}},[this._v("#")]),this._v(" 設定範例")])},function(){var t=this.$createElement,e=this._self._c||t;return e("p",[this._v("找到 "),e("code",[this._v("nginx.conf")]),this._v(" 檔案並編輯，預設會在 "),e("code",[this._v("/etc/nginx/nginx.conf")])])},function(){var t=this,e=t.$createElement,s=t._self._c||e;return s("div",{staticClass:"language-sh line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v('  ##\n  # Gzip Setting\n  ##\n\n  gzip on;\n  gzip_types text/plain application/json;\n  gzip_proxied any;\n  gzip_disable "msie6";\n  gzip_min_length 1024;\n  gzip_comp_level 3;\n')])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br"),s("span",{staticClass:"line-number"},[t._v("4")]),s("br"),s("span",{staticClass:"line-number"},[t._v("5")]),s("br"),s("span",{staticClass:"line-number"},[t._v("6")]),s("br"),s("span",{staticClass:"line-number"},[t._v("7")]),s("br"),s("span",{staticClass:"line-number"},[t._v("8")]),s("br"),s("span",{staticClass:"line-number"},[t._v("9")]),s("br"),s("span",{staticClass:"line-number"},[t._v("10")]),s("br")])])},function(){var t=this.$createElement,e=this._self._c||t;return e("div",{staticClass:"tip custom-block"},[e("p",{staticClass:"custom-block-title"},[this._v("使用 Nginx Container 的場合")]),this._v(" "),e("ul",[e("li",[this._v("docker exec -it nginx /bin/sh")]),this._v(" "),e("li",[this._v("vi /etc/nginx/nginx.conf")])])])},function(){var t=this.$createElement,e=this._self._c||t;return e("h3",{attrs:{id:"directives-說明"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#directives-說明","aria-hidden":"true"}},[this._v("#")]),this._v(" Directives 說明")])},function(){var t=this.$createElement,e=this._self._c||t;return e("div",{staticClass:"tip custom-block"},[e("p",{staticClass:"custom-block-title"},[this._v("1. gzip")]),this._v(" "),e("p",[this._v("Syntax:\tgzip on | off;")]),this._v(" "),e("p",[this._v("Default:\t\ngzip off;")]),this._v(" "),e("p",[this._v("Context:\thttp, server, location, if in location")])])},function(){var t=this.$createElement,e=this._self._c||t;return e("p",[this._v("預設情況下，Nginx 的 Gzip 是關閉的，設定為 "),e("code",[this._v("on")]),this._v(" 後，nginx 將對 reponse 進行壓縮")])},function(){var t=this.$createElement,e=this._self._c||t;return e("div",{staticClass:"tip custom-block"},[e("p",{staticClass:"custom-block-title"},[this._v("2. gzip_types")]),this._v(" "),e("p",[this._v("Syntax:\tgzip_types mime-type ...;")]),this._v(" "),e("p",[this._v("Default:\t\ngzip_types text/html;")]),this._v(" "),e("p",[this._v("Context:\thttp, server, location")])])},function(){var t=this.$createElement,e=this._self._c||t;return e("p",[this._v("開啟 gzip 後，預設只對 "),e("code",[this._v("text/html")]),this._v(" 進行壓縮，如果要對其他類型的 MIME 壓縮。需要搭配 gzip_types 自行添加，比如：")])},function(){var t=this,e=t.$createElement,s=t._self._c||e;return s("ul",[s("li",[s("code",[t._v("＊")]),t._v(" , 一律壓縮")]),t._v(" "),s("li",[t._v("添加要壓縮的類型，"),s("code",[t._v("text/plain")]),t._v(", "),s("code",[t._v("text/css")]),t._v(",  "),s("code",[t._v("application/x-javascript")]),t._v(",  "),s("code",[t._v("application/javascript")]),t._v(", "),s("code",[t._v("application/xml")])]),t._v(" "),s("li",[t._v("如果要對圖片壓縮，可用 "),s("code",[t._v("image/jpeg")]),t._v(" "),s("code",[t._v("image/gif")]),t._v(" "),s("code",[t._v("image/png")])])])},function(){var t=this.$createElement,e=this._self._c||t;return e("div",{staticClass:"tip custom-block"},[e("p",{staticClass:"custom-block-title"},[this._v("3. gzip_proxied")]),this._v(" "),e("p",[this._v("Syntax:\tgzip_proxied off | expired | no-cache | no-store | private | no_last_modified | no_etag | auth | any ...;")]),this._v(" "),e("p",[this._v("Default:\t\ngzip_proxied off;")]),this._v(" "),e("p",[this._v("Context:\thttp, server, location")])])},function(){var t=this.$createElement,e=this._self._c||t;return e("p",[this._v("如果 nginx 做為前端的反向代理，設定 "),e("code",[this._v("any")]),this._v(" 的話，會對後端/上游 server 返回的 response 一律進行壓縮。")])},function(){var t=this,e=t.$createElement,s=t._self._c||e;return s("div",{staticClass:"tip custom-block"},[s("p",{staticClass:"custom-block-title"},[t._v("4. gzip_disable")]),t._v(" "),s("p",[t._v("Syntax:\tgzip_disable regex ...;")]),t._v(" "),s("p",[t._v("Default:\t—")]),t._v(" "),s("p",[t._v("Context:\thttp, server, location")]),t._v(" "),s("p",[t._v("This directive appeared in version 0.6.23.")])])},function(){var t=this.$createElement,e=this._self._c||t;return e("p",[this._v("根據請求中的 "),e("code",[this._v("User-Agent")]),this._v(" 欄位判斷需不需要 gzip，像設定 "),e("code",[this._v('"msie6"')]),this._v(" 等價於 "),e("code",[this._v('"MSIE [4-6]\\."')]),this._v(" （正則表達），也就是 IE6 以下一律不做 Gzip，防止瀏覽器出現錯誤。")])},function(){var t=this.$createElement,e=this._self._c||t;return e("div",{staticClass:"tip custom-block"},[e("p",{staticClass:"custom-block-title"},[this._v("5. gzip_min_length")]),this._v(" "),e("p",[this._v("Syntax:\tgzip_min_length length;")]),this._v(" "),e("p",[this._v("Default:\t\ngzip_min_length 20;")]),this._v(" "),e("p",[this._v("Context:\thttp, server, location")])])},function(){var t=this.$createElement,e=this._self._c||t;return e("p",[this._v("根據 "),e("code",[this._v("Content-Length")]),this._v(" 判斷要不要壓縮，如果小於設定的數字，則不需要壓縮。 Rule of thumb 是 1k，寫成 gzip_min_length 1k;")])},function(){var t=this.$createElement,e=this._self._c||t;return e("div",{staticClass:"tip custom-block"},[e("p",{staticClass:"custom-block-title"},[this._v("6. gzip_comp_level")]),this._v(" "),e("p",[this._v("Syntax:\tgzip_comp_level level;")]),this._v(" "),e("p",[this._v("Default:\t\ngzip_comp_level 1; # 1~9")]),this._v(" "),e("p",[this._v("Context:\thttp, server, location")])])},function(){var t=this.$createElement,e=this._self._c||t;return e("h2",{attrs:{id:"client-端-cache"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#client-端-cache","aria-hidden":"true"}},[this._v("#")]),this._v(" client 端 cache")])},function(){var t=this.$createElement,e=this._self._c||t;return e("p",[this._v("如果能夠快取及重複使用先前取得的資源，減少到遠端取得內容的次數，可縮短瀏覽器處理內容的時間，並節省傳輸費用。"),e("sup",{staticClass:"footnote-ref"},[e("a",{attrs:{href:"#fn2",id:"fnref2"}},[this._v("[2]")])])])},function(){var t=this.$createElement,e=this._self._c||t;return e("p",[e("img",{attrs:{src:"https://developers.google.com/web/fundamentals/performance/optimizing-content-efficiency/images/http-request.png?hl=zh-tw",alt:""}})])},function(){var t=this.$createElement,e=this._self._c||t;return e("table",[e("thead",[e("tr",[e("th",{staticStyle:{"text-align":"center"}},[e("strong",[this._v("Cache-Control")])]),this._v(" "),e("th",{staticStyle:{"text-align":"center"}},[e("strong",[this._v("說明")])])])]),this._v(" "),e("tbody",[e("tr",[e("td",{staticStyle:{"text-align":"center"}},[e("code",[this._v("max-age=120")])]),this._v(" "),e("td",{staticStyle:{"text-align":"center"}},[this._v("瀏覽器和任何中繼快取都可以快取回應，時限為 120 秒")])])])])},function(){var t=this.$createElement,e=this._self._c||t;return e("h3",{attrs:{id:"設定範例-2"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#設定範例-2","aria-hidden":"true"}},[this._v("#")]),this._v(" 設定範例")])},function(){var t=this.$createElement,e=this._self._c||t;return e("p",[this._v("以 "),e("code",[this._v("Cache-Control")]),this._v(" header 為例：")])},function(){var t=this,e=t.$createElement,s=t._self._c||e;return s("div",{staticClass:"language-sh line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v('  # 請求 / 位址時，如果請求資源為以下幾種，則快取時限為 30 天\n  # Cache-Control: max-age=2592000\n  location / {\n    if ($request_uri ~* ".(ico|css|js|gif|jpe?g|png)$") {\n      expires 30d;\n    }\n  }\n\n  # 也可以使用 map 根據不同情況判定\n  map $sent_http_content_type $expires {\n    default         off;\n    application/pdf 42d;\n    ~image/         max;\n  }\n\n  # 在不同的 block，可以取用到 map 的 $expires 變數\n  expires $expires;\n')])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br"),s("span",{staticClass:"line-number"},[t._v("4")]),s("br"),s("span",{staticClass:"line-number"},[t._v("5")]),s("br"),s("span",{staticClass:"line-number"},[t._v("6")]),s("br"),s("span",{staticClass:"line-number"},[t._v("7")]),s("br"),s("span",{staticClass:"line-number"},[t._v("8")]),s("br"),s("span",{staticClass:"line-number"},[t._v("9")]),s("br"),s("span",{staticClass:"line-number"},[t._v("10")]),s("br"),s("span",{staticClass:"line-number"},[t._v("11")]),s("br"),s("span",{staticClass:"line-number"},[t._v("12")]),s("br"),s("span",{staticClass:"line-number"},[t._v("13")]),s("br"),s("span",{staticClass:"line-number"},[t._v("14")]),s("br"),s("span",{staticClass:"line-number"},[t._v("15")]),s("br"),s("span",{staticClass:"line-number"},[t._v("16")]),s("br"),s("span",{staticClass:"line-number"},[t._v("17")]),s("br")])])},function(){var t=this.$createElement,e=this._self._c||t;return e("h3",{attrs:{id:"directives-說明-2"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#directives-說明-2","aria-hidden":"true"}},[this._v("#")]),this._v(" Directives 說明 "),e("sup",{staticClass:"footnote-ref"},[e("a",{attrs:{href:"#fn3",id:"fnref3"}},[this._v("[3]")])])])},function(){var t=this,e=t.$createElement,s=t._self._c||e;return s("div",{staticClass:"tip custom-block"},[s("p",{staticClass:"custom-block-title"},[t._v("1. expires")]),t._v(" "),s("p",[t._v("Syntax:\texpires [modified] time;")]),t._v(" "),s("p",[t._v("expires epoch | max | off;")]),t._v(" "),s("p",[t._v("Default:\t\nexpires off;")]),t._v(" "),s("p",[t._v("Context:\thttp, server, location, if in location")])])},function(){var t=this.$createElement,e=this._self._c||t;return e("p",[this._v("根據 expires 給定的時間，影響 "),e("code",[this._v("Cache-Control")]),this._v(" header 的行爲：")])},function(){var t=this,e=t.$createElement,s=t._self._c||e;return s("ul",[s("li",[t._v("負值 — "),s("code",[t._v("Cache-Control: no-cache")])]),t._v(" "),s("li",[t._v("大於等於 0 — "),s("code",[t._v("Cache-Control: max-age=t")]),t._v(", t 以秒計")]),t._v(" "),s("li",[t._v("epoch - 等價於 expires Thu, 01 Jan 1970 00:00:01 GMT，而 "),s("code",[t._v("Cache-Control: no-cache")]),t._v(".")]),t._v(" "),s("li",[t._v("max - 給你 10 年")])])},function(){var t=this.$createElement,e=this._self._c||t;return e("div",{staticClass:"tip custom-block"},[e("p",{staticClass:"custom-block-title"},[this._v("2. add_header")]),this._v(" "),e("p",[this._v("Syntax:\tadd_header name value [always];")]),this._v(" "),e("p",[this._v("Default:\t—")]),this._v(" "),e("p",[this._v("Context:\thttp, server, location, if in location")])])},function(){var t=this.$createElement,e=this._self._c||t;return e("pre",[e("code",[this._v("  add_header Cache-Control private/public no-cache/no-store max-age=t;\n")])])},function(){var t=this.$createElement,e=this._self._c||t;return e("ul",[e("li",[this._v("public")])])},function(){var t=this.$createElement,e=this._self._c||t;return e("ul",[e("li",[this._v("private")])])},function(){var t=this.$createElement,e=this._self._c||t;return e("ul",[e("li",[this._v("no-cache")])])},function(){var t=this.$createElement,e=this._self._c||t;return e("ul",[e("li",[this._v("no-store")])])},function(){var t=this.$createElement,e=this._self._c||t;return e("div",{staticClass:"tip custom-block"},[e("p",{staticClass:"custom-block-title"},[this._v("3. etag")]),this._v(" "),e("p",[this._v("Syntax:\tetag on | off;")]),this._v(" "),e("p",[this._v("Default:\t\netag on;")]),this._v(" "),e("p",[this._v("Context:\thttp, server, location")])])},function(){var t=this.$createElement,e=this._self._c||t;return e("h3",{attrs:{id:"運作方式"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#運作方式","aria-hidden":"true"}},[this._v("#")]),this._v(" 運作方式")])},function(){var t=this.$createElement,e=this._self._c||t;return e("p",[e("img",{attrs:{src:"https://developers.google.com/web/fundamentals/performance/optimizing-content-efficiency/images/http-request.png?hl=zh-tw",alt:""}})])},function(){var t=this.$createElement,e=this._self._c||t;return e("h3",{attrs:{id:"強制更新"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#強制更新","aria-hidden":"true"}},[this._v("#")]),this._v(" 強制更新")])},function(){var t=this.$createElement,e=this._self._c||t;return e("ul",[e("li",[this._v("對於開發者，")])])},function(){var t=this.$createElement,e=this._self._c||t;return e("p",[this._v("你可以打開 chrome 瀏覽器的開發者模式，按住 "),e("code",[this._v("option")]),this._v("，再對 "),e("code",[this._v("重新整理")]),this._v(" 按右鍵選擇清除快取並重新載入。")])},function(){var t=this.$createElement,e=this._self._c||t;return e("p",[e("img",{attrs:{src:"https://i.imgur.com/l9Yfb5A.png",alt:""}})])},function(){var t=this.$createElement,e=this._self._c||t;return e("ul",[e("li",[this._v("對於你的用戶，")])])},function(){var t=this.$createElement,e=this._self._c||t;return e("h2",{attrs:{id:"server-端-cache"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#server-端-cache","aria-hidden":"true"}},[this._v("#")]),this._v(" server 端 cache")])},function(){var t=this.$createElement,e=this._self._c||t;return e("h3",{attrs:{id:"設定範例-3"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#設定範例-3","aria-hidden":"true"}},[this._v("#")]),this._v(" 設定範例")])},function(){var t=this,e=t.$createElement,s=t._self._c||e;return s("div",{staticClass:"language-sh line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v('http {\n  proxy_cache_path /tmp/nginx levels=1:2 keys_zone=slowfile_cache:10m inactive=60m use_temp_path=off;\n\n  # include /etc/nginx/conf.d/*.conf;\n  server {\n    location / {\n      proxy_cache_key "$request_uri";\n      proxy_cache slowfile_cache;\n      proxy_cache_valid 200 302 5m;\n      proxy_cache_valid 404      1m;\n      proxy_ignore_headers Cache-Control X-Accel-Redirect X-Accel-Expires X-Accel-Limit-Rate X-Accel-Buffering X-Accel-Charset Expires Set-Cookie Vary;\n      add_header X-Proxy-Cache $upstream_cache_status;\n\n      proxy_pass http://node-cluster;\n    }\n  }\n}\n')])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br"),s("span",{staticClass:"line-number"},[t._v("4")]),s("br"),s("span",{staticClass:"line-number"},[t._v("5")]),s("br"),s("span",{staticClass:"line-number"},[t._v("6")]),s("br"),s("span",{staticClass:"line-number"},[t._v("7")]),s("br"),s("span",{staticClass:"line-number"},[t._v("8")]),s("br"),s("span",{staticClass:"line-number"},[t._v("9")]),s("br"),s("span",{staticClass:"line-number"},[t._v("10")]),s("br"),s("span",{staticClass:"line-number"},[t._v("11")]),s("br"),s("span",{staticClass:"line-number"},[t._v("12")]),s("br"),s("span",{staticClass:"line-number"},[t._v("13")]),s("br"),s("span",{staticClass:"line-number"},[t._v("14")]),s("br"),s("span",{staticClass:"line-number"},[t._v("15")]),s("br"),s("span",{staticClass:"line-number"},[t._v("16")]),s("br"),s("span",{staticClass:"line-number"},[t._v("17")]),s("br")])])},function(){var t=this.$createElement,e=this._self._c||t;return e("h3",{attrs:{id:"directives-說明-3"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#directives-說明-3","aria-hidden":"true"}},[this._v("#")]),this._v(" Directives 說明"),e("sup",{staticClass:"footnote-ref"},[e("a",{attrs:{href:"#fn4",id:"fnref4"}},[this._v("[4]")])])])},function(){var t=this.$createElement,e=this._self._c||t;return e("ol",[e("li",[e("p",[this._v("首先設定 cache 檔案的存放位置以及相關資訊，")]),this._v(" "),e("pre",[e("code",[this._v(" proxy_cache_path /tmp/nginx levels=1:2 keys_zone=slowfile_cache:10m inactive=60m use_temp_path=off;\n")])])])])},function(){var t=this,e=t.$createElement,s=t._self._c||e;return s("ul",[s("li",[s("p",[t._v("path: 本機快取存放的路徑，在此設定 "),s("code",[t._v("/tmp/nginx")])])]),t._v(" "),s("li",[s("p",[t._v("levels: 快取儲存的資料夾層級，如果全部快取都放在 "),s("code",[t._v("/tmp/nginx")]),t._v(" 下，效率肯定不好，Rule of thumb 是放兩層 "),s("code",[t._v("levels=1:2")]),t._v("。")])]),t._v(" "),s("li",[s("p",[t._v("keys_zone=slowfile_cache:10m：")])])])},function(){var t=this.$createElement,e=this._self._c||t;return e("p",[this._v("在記憶體中規劃一塊區域來存 cache 的 key 和 metadata，讓 nginx 快速判斷 request 是否在 cache 中，1m 可以放 8000 個 keys，10m 可以放 80000 個。我把這個區域叫 "),e("code",[this._v("slowfile_cache")]),this._v("。"),e("sup",{staticClass:"footnote-ref"},[e("a",{attrs:{href:"#fn5",id:"fnref5"}},[this._v("[5]")])])])},function(){var t=this.$createElement,e=this._self._c||t;return e("li",[e("p",[this._v("inactive: 設定未被存取檔案在 cache 要保留多久，預設是 10 分鐘，時間超過都沒人存取，就會刪除。")])])},function(){var t=this.$createElement,e=this._self._c||t;return e("ol",{attrs:{start:"2"}},[e("li",[e("p",[this._v("接著，在想套用的 reverse proxy 的 location 啟用 proxy cache，指定 key_zone")]),this._v(" "),e("pre",[e("code",[this._v(" proxy_cache slowfile_cache;\n")])])]),this._v(" "),e("li",[e("p",[this._v("其中的細節設定：")])])])},function(){var t=this.$createElement,e=this._self._c||t;return e("ul",[e("li",[e("p",[this._v("proxy_cache_key: 定義 cache 的 key 名")])]),this._v(" "),e("li",[e("p",[this._v("proxy_cache_valid: 可以全部套用，也可以針對不同狀態碼給定不同 cache 時間")]),this._v(" "),e("p",[this._v("proxy_cache_valid 200 302 5m; proxy_cache_valid 404 1m;")])]),this._v(" "),e("li",[e("p",[this._v("proxy_ignore_headers: Disables processing of certain response header fields from the proxied server，如果從 後端/上游 server 返回的 response 有這些 header 就不 cache。")])])])},function(){var t=this.$createElement,e=this._self._c||t;return e("h2",{attrs:{id:"測試"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#測試","aria-hidden":"true"}},[this._v("#")]),this._v(" 測試")])},function(){var t=this.$createElement,e=this._self._c||t;return e("pre",[e("code",[this._v("    nginx -t\n")])])},function(){var t=this,e=t.$createElement,s=t._self._c||e;return s("div",{staticClass:"tip custom-block"},[s("p",{staticClass:"custom-block-title"},[t._v("使用 Nginx Container 的場合")]),t._v(" "),s("ul",[s("li",[t._v("docker exec -it nginx /bin/sh")]),t._v(" "),s("li",[t._v("nginx -t")]),t._v(" "),s("li",[t._v("control + P + Q # 離開但不會停止 container")]),t._v(" "),s("li",[t._v("docker-compose restart nginx")])])])},function(){var t=this.$createElement,e=this._self._c||t;return e("p",[this._v("設定前，設定後比較，client 端使用了 cache，減少了大量的頁面載入時間，在大檔案尤其明顯\n"),e("img",{attrs:{src:"https://i.imgur.com/jGXzsZ1.png",alt:""}})])},function(){var t=this.$createElement,e=this._self._c||t;return e("h2",{attrs:{id:"參考資料"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#參考資料","aria-hidden":"true"}},[this._v("#")]),this._v(" 參考資料")])}],!1,null,null,null);e.default=n.exports}}]);