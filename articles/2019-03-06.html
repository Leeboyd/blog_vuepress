<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>RUN vs CMD vs ENTRYPOINT | DEV.Boy</title>
    <meta name="description" content="Think twice, code once.">
    <link rel="icon" href="/blog_vuepress/assets/img/icon.png">
    
    <link rel="preload" href="/blog_vuepress/assets/css/0.styles.655d990b.css" as="style"><link rel="preload" href="/blog_vuepress/assets/js/app.c16370cc.js" as="script"><link rel="preload" href="/blog_vuepress/assets/js/10.a3bf57f3.js" as="script"><link rel="prefetch" href="/blog_vuepress/assets/js/11.2305f366.js"><link rel="prefetch" href="/blog_vuepress/assets/js/12.d914188e.js"><link rel="prefetch" href="/blog_vuepress/assets/js/13.57cea0c3.js"><link rel="prefetch" href="/blog_vuepress/assets/js/14.dfd715d5.js"><link rel="prefetch" href="/blog_vuepress/assets/js/15.9b71fef1.js"><link rel="prefetch" href="/blog_vuepress/assets/js/2.3b2c723b.js"><link rel="prefetch" href="/blog_vuepress/assets/js/3.2922585c.js"><link rel="prefetch" href="/blog_vuepress/assets/js/4.7fd15097.js"><link rel="prefetch" href="/blog_vuepress/assets/js/5.d19ad4b7.js"><link rel="prefetch" href="/blog_vuepress/assets/js/6.c84ca870.js"><link rel="prefetch" href="/blog_vuepress/assets/js/7.7ea9c63e.js"><link rel="prefetch" href="/blog_vuepress/assets/js/8.a87e3793.js"><link rel="prefetch" href="/blog_vuepress/assets/js/9.60ab9a27.js">
    <link rel="stylesheet" href="/blog_vuepress/assets/css/0.styles.655d990b.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/blog_vuepress/" class="home-link router-link-active"><img src="/blog_vuepress/assets/img/logo.png" alt="DEV.Boy" class="logo"> <span class="site-name can-hide">DEV.Boy</span></a> <div class="links" style="max-width:nullpx;"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/blog_vuepress/articles/" class="nav-link router-link-active">Articles</a></div><div class="nav-item"><a href="/blog_vuepress/diary.html" class="nav-link">Diary</a></div><div class="nav-item"><a href="/blog_vuepress/about.html" class="nav-link">About</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/blog_vuepress/articles/" class="nav-link router-link-active">Articles</a></div><div class="nav-item"><a href="/blog_vuepress/diary.html" class="nav-link">Diary</a></div><div class="nav-item"><a href="/blog_vuepress/about.html" class="nav-link">About</a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/blog_vuepress/articles/2019-03-06.html" class="active sidebar-link">Table of Content</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog_vuepress/articles/2019-03-06.html#摘要" class="sidebar-link">摘要</a></li><li class="sidebar-sub-header"><a href="/blog_vuepress/articles/2019-03-06.html#shell-格式" class="sidebar-link">shell 格式</a></li><li class="sidebar-sub-header"><a href="/blog_vuepress/articles/2019-03-06.html#exec-格式" class="sidebar-link">exec 格式</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog_vuepress/articles/2019-03-06.html#推薦：exec-格式" class="sidebar-link">推薦：exec 格式</a></li></ul></li><li class="sidebar-sub-header"><a href="/blog_vuepress/articles/2019-03-06.html#run" class="sidebar-link">RUN</a></li><li class="sidebar-sub-header"><a href="/blog_vuepress/articles/2019-03-06.html#cmd" class="sidebar-link">CMD</a></li><li class="sidebar-sub-header"><a href="/blog_vuepress/articles/2019-03-06.html#entrypoint" class="sidebar-link">ENTRYPOINT</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog_vuepress/articles/2019-03-06.html#舉例：cmd-與-entrypoint" class="sidebar-link">舉例：CMD 與 ENTRYPOINT</a></li></ul></li><li class="sidebar-sub-header"><a href="/blog_vuepress/articles/2019-03-06.html#best-practices" class="sidebar-link">Best Practices[^1]</a></li></ul></li></ul> </div> <div class="page"> <div class="content"><h1 id="run-vs-cmd-vs-entrypoint"><a href="#run-vs-cmd-vs-entrypoint" aria-hidden="true" class="header-anchor">#</a> RUN vs CMD vs ENTRYPOINT</h1> <h5 id="tags-docker-dockerfile"><a href="#tags-docker-dockerfile" aria-hidden="true" class="header-anchor">#</a> tags: <code>docker</code>, <code>Dockerfile</code></h5> <h2 id="摘要"><a href="#摘要" aria-hidden="true" class="header-anchor">#</a> 摘要</h2> <p>Dockerfile 中 <code>RUN</code>, <code>CMD</code> and <code>ENTRYPOINT</code> 這三個指令常會混淆，故在此做個筆記。</p> <ol><li><p><code>RUN</code>: 會建立一層 image，用於安裝 dependency</p></li> <li><p><code>CMD</code>, <code>ENTRYPOINT</code>: 容器在啟動時時預設會跑的指令, 兩者有些區別：</p></li></ol> <p>Any command line arguments passed to <code>docker run &lt;image&gt;</code> will be appended to the <code>ENTRYPOINT</code>,
and will override all elements using <code>CMD</code>.</p> <h2 id="shell-格式"><a href="#shell-格式" aria-hidden="true" class="header-anchor">#</a> shell 格式</h2> <pre><code> &lt;instruction&gt; command param1
</code></pre> <p>當指令執行時，shell 格式底層會呼叫 shell process, 成為 <code>/bin/sh -c &lt;command&gt;</code>，</p> <ul><li>RUN apt-get install jq</li> <li>CMD echo &quot;Hello, $name&quot;</li> <li>ENTRYPOINT echo &quot;Hello, $name&quot;</li></ul> <div class="language- line-numbers-mode"><pre class="language-text"><code>ENV name boy

ENTRYPOINT echo &quot;Hello, $name&quot;
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>執行 <code>docker run &lt;image&gt;</code>, 會輸出：<code>Hello, boy</code>, 因為使用了 shell process 中的環境變數 $name.</p> <h2 id="exec-格式"><a href="#exec-格式" aria-hidden="true" class="header-anchor">#</a> exec 格式</h2> <pre><code> &lt;instruction&gt; [&quot;executable&quot;, &quot;param1&quot;, &quot;param2&quot;, ...]
</code></pre> <ul><li>RUN [&quot;apt-get&quot;, &quot;install&quot;, &quot;jq&quot;]</li> <li>CMD [&quot;/bin/sh&quot;, &quot;-c&quot;, &quot;echo Hello, $name&quot;]</li> <li>ENTRYPOINT [&quot;/bin/sh&quot;, &quot;-c&quot;, &quot;echo Hello, $name&quot;]</li></ul> <p>請注意，如果 Dockerfile 是這樣寫：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>ENV name boy

ENTRYPOINT [&quot;/bin/echo&quot;, &quot;Hello, $name&quot;]
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>執行 <code>docker run &lt;image&gt;</code>, 會輸出：<code>Hello, $name</code>, 如果希望使用環境變數 $name，可修改成</p> <pre><code>ENTRYPOINT [&quot;/bin/sh&quot;, &quot;-c&quot;, &quot;echo Hello, $name&quot;]
</code></pre> <div class="tip custom-block"><p class="custom-block-title">TIP</p> <p>ENTRYPOINT 使用 shell 格式時，會忽略 CMD 和 <code>docker run &lt;image&gt;</code> 傳入的參數，如果要替換預設指令，需要在 <code>docker run &lt;image&gt;</code> 時指定 <code>--entrypoint</code>。</p></div> <h3 id="推薦：exec-格式"><a href="#推薦：exec-格式" aria-hidden="true" class="header-anchor">#</a> 推薦：exec 格式</h3> <p>指令的可讀性較高，使用 exec 格式時，Docker 不會使用 command shell 解析，而是做為容器的 PID 1, 故可以接收 Unix signal，比如執行 docker stop 時能夠收到 <code>SIGTERM</code></p> <div class="tip custom-block"><p class="custom-block-title">TIP</p> <p>ENTRYPOINT 使用 shell 格式時，並非容器的 PID 1, 而是作為 <code>/bin/sh -c</code> 的子命令，所以不會接收 Unix signal</p></div> <h2 id="run"><a href="#run" aria-hidden="true" class="header-anchor">#</a> RUN</h2> <p><code>RUN</code> 指令通常用於安裝 depenencies, 會在當前的 image 頂部執行，再疊一個新的 image。</p> <p><code>RUN</code> 使用 exec, shell 皆可：</p> <div class="language-sh line-numbers-mode"><pre class="language-text"><code>RUN apt-get update &amp;&amp; apt-get install -y \
bzr \
git \
jq \
htop
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><div class="tip custom-block"><p class="custom-block-title">TIP</p> <p>將 <code>apt-get update &amp;&amp; apt-get install</code> 放在同一個 <code>RUN</code> 執行，除了可以減少 image 的層數之外，也能夠確保每次安裝的套件都是最新的，如果不同層，<code>RUN apt-get update</code> 這層可能是使用之前 cache 的。</p></div> <h2 id="cmd"><a href="#cmd" aria-hidden="true" class="header-anchor">#</a> CMD</h2> <p><code>CMD</code> (Dockerfile) / <code>command</code> (docker-compose) 是 container 起動時的預設指令</p> <ul><li><p>如果 Dockerfile 有多個 <code>CMD</code> 只有最後一個會生效。</p></li> <li><p>如果 同時有 <code>ENTRYPOINT</code> 的話，會在 <code>ENTRYPOINT</code> 後執行，或作為參數</p></li> <li><p>舉例：</p> <ul><li>CMD [&quot;executable&quot;, &quot;param1&quot;, &quot;param2&quot;, ...]</li> <li>或作為參數，CMD [&quot;param1&quot;. &quot;param2&quot;]</li></ul></li> <li><p>override</p> <p>when specifies arguments after <code>docker run &lt;image&gt;</code>, it will override the default <code>CMD</code>
docker run rails_image rails console</p></li></ul> <h2 id="entrypoint"><a href="#entrypoint" aria-hidden="true" class="header-anchor">#</a> ENTRYPOINT</h2> <p><code>ENTRYPOINT</code> 指令可以讓容器以 process 或 service 的形式運行。</p> <ul><li>有 shell 和 exec 兩種格式，有所差異詳見上方說明。</li> <li><code>CMD</code>, docker run 傳入的參數會附在 <code>ENTRYPOINT</code> 之後，前提是使用 exec 格式。</li></ul> <h3 id="舉例：cmd-與-entrypoint"><a href="#舉例：cmd-與-entrypoint" aria-hidden="true" class="header-anchor">#</a> 舉例：CMD 與 ENTRYPOINT</h3> <div class="language-dockerfile line-numbers-mode"><pre class="language-text"><code>  ENTRYPOINT [&quot;/bin/echo&quot;, &quot;Hello&quot;]
  CMD [&quot;World&quot;]
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p><code>$ docker run -it [image]</code> 輸出為 <code>Hello World</code></p> <p><code>$ docker run -it [image] boy</code> 輸出為 <code>Hello boy</code></p> <h2 id="best-practices"><a href="#best-practices" aria-hidden="true" class="header-anchor">#</a> Best Practices<sup class="footnote-ref"><a href="#fn1" id="fnref1">[1]</a></sup></h2> <ol><li>使用 <code>RUN</code> 安裝套件，建立 image</li> <li>如果 image 用途是作為 process 或 service 的容器的話，使用 exec 格式的 <code>ENTRYPOINT</code>，而 <code>CMD</code> 提供預設參數/flag</li></ol> <div class="language-dockerfile line-numbers-mode"><pre class="language-text"><code>FROM alpine
ENTRYPOINT [&quot;top&quot;, &quot;-b&quot;]
CMD [&quot;-c&quot;]
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><ol start="3"><li>如果需要 override <code>CMD</code>, 在 <code>docker run &lt;image&gt;</code> 時傳入。</li></ol> <hr class="footnotes-sep"> <section class="footnotes"><ol class="footnotes-list"><li id="fn1" class="footnote-item"><p><a href="https://medium.freecodecamp.org/docker-entrypoint-cmd-dockerfile-best-practices-abc591c30e21" target="_blank" rel="noopener noreferrer">Docker ENTRYPOINT &amp; CMD: Dockerfile best practices<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> <a href="#fnref1" class="footnote-backref">↩︎</a></p></li></ol></section></div> <div class="page-edit"><!----> <!----></div> <!----> </div> <!----></div></div>
    <script src="/blog_vuepress/assets/js/app.c16370cc.js" defer></script><script src="/blog_vuepress/assets/js/10.a3bf57f3.js" defer></script>
  </body>
</html>
